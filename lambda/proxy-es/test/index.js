process.env.AWS_PROFILE=require('../../../config').profile
process.env.AWS_DEFAULT_REGION=require('../../../config').profile
var handler=require('../index').handler
var Promise=require('bluebird')
var cfn=Promise.promisifyAll(require('../index'),{multiArgs:true})
var outputs=require('../../../bin/exports')

module.exports={
    qid:async function(test){
        var info=await outputs('dev/master')
        process.env.ES_ADDRESS=info.ElasticsearchEndpoint
        process.env.ES_INDEX=info.ElasticsearchIndex
        process.env.ES_TYPE=info.ElasticsearchType

        require('../index').qid({
           qid:'test.1' 
        },{},function(error,result){
            console.log("result:",JSON.stringify(result,null,2))
            console.log("error:",error)
            test.ok(result)
            test.done()
        })
    },
    query:async function(test){
        var info=await outputs('dev/master')
        require('../index').query({
            req:{
                "question": "help",
                session:{},
                "_info":{
                    es:{
                        address:info.ElasticsearchEndpoint,
                        index:info.ElasticsearchIndex,
                        type:info.ElasticsearchType,
                    }
                }
            },
            res:{
                session:{}
            }
        },{},function(error,result){
            console.log("result:",JSON.stringify(result,null,2))
            console.log("error:",error)
            test.ok(result.req)
            test.ok(result.res)
            test.done()
        })
    },
    error:function(test){    
        outputs('dev/master').then(function(output){
        handler({
            endpoint:output.ElasticsearchEndpoint,
            method:'HEAD',
            path:"/test/test/test",
        },{},function(error,result){
            test.ok(error)
            console.log("result:",JSON.stringify(result,null,2))
            console.log("error:",error)
            test.done()
        })
        })
    },
    get:function(test){    
        outputs('dev/master').then(function(output){
        handler({
            endpoint:output.ElasticsearchEndpoint,
            method:'GET',
            path:"/",
        },{},function(error,result){
            test.ifError(error)
            test.ok(result)
            console.log("result:",JSON.stringify(result,null,2))
            test.done()
        })
        })
    },
    post:function(test){
        outputs('dev/master').then(function(output){
        handler({
            endpoint:output.ElasticsearchEndpoint,
            method:'POST',
            path:"/"+output.ElasticsearchIndex+'/'+output.ElasticsearchType+'/test',
            body:{
                qid:"test"
            }
        },{},function(error,result){
            test.ifError(error)
            test.ok(result)
            console.log("result:",JSON.stringify(result,null,2))
            test.done()
        })
        })
    },
    bulk:function(test){    
        outputs('dev/master').then(function(output){
        handler({
            endpoint:output.ElasticsearchEndpoint,
            method:'POST',
            path:"/_bulk",
            body:[
                {delete:{
                    _index:output.ElasticsearchIndex,
                    _type:output.ElasticsearchType,
                    _id:"test-tmp.1"    
                }},
                {delete:{
                    _index:output.ElasticsearchIndex,
                    _type:output.ElasticsearchType,
                    _id:"test-tmp.2"    
                }}
            ]
        },{},function(error,result){
            console.log("error:"+JSON.stringify(error))
            test.ifError(error)
            test.ok(result)
            console.log("result:",JSON.stringify(result,null,2))
            test.done()
        })
        })
    },
    create:function(test){  
        outputs('dev/master').then(function(output){
            return cfn.CreateAsync({create:{ 
                endpoint:output.ElasticsearchEndpoint,
                method:'GET',
                path:"/"
            }})
        })
        .tap(console.log)
        .then(test.ok)
        .catch(test.ifError)
        .finally(test.done)
    },
    update:function(test){
        outputs('dev/master').then(function(output){
            return cfn.UpdateAsync("",{create:{ 
                endpoint:output.ElasticsearchEndpoint,
                method:'GET',
                path:"/"
            }},{})
        })
        .tap(console.log)
        .then(test.ok)
        .catch(test.ifError)
        .finally(test.done)
    },
    delete:function(test){
        outputs('dev/master').then(function(output){
            return cfn.DeleteAsync("",{delete:{ 
                endpoint:output.ElasticsearchEndpoint,
                method:'GET',
                path:"/"
            }})
        })
        .tap(console.log)
        .then(test.ok)
        .catch(test.ifError)
        .finally(test.done)
    }
}
